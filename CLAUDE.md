# AI開発ガイド - パチンコグラフ解析システム

このドキュメントは、AIアシスタント（Claude等）がこのプロジェクトを理解し、効率的に開発を支援するためのガイドです。

## 📋 プロジェクト概要

**パチンコグラフ解析システム v2.0**は、site7のパチンコ台グラフ画像を自動解析するStreamlitベースのWebアプリケーションです。

### コアコンセプト
- **site7専用**: site7（https://m.site777.jp/）のグラフフォーマットに特化
- **完全自動化**: アップロードから解析まですべて自動
- **高精度**: ピクセル単位での精密な解析
- **ユーザーフレンドリー**: 技術知識不要の簡単操作

## 🏗️ アーキテクチャ

### メインコンポーネント

```
web_app/
├── streamlit_app_full.py  # メインアプリケーション
│   ├── UIロジック
│   ├── ファイルアップロード処理
│   ├── プログレス表示
│   └── 結果表示
│
└── web_analyzer.py        # 解析エンジン
    ├── グラフ検出
    ├── データ抽出
    └── 統計計算
```

### 処理フロー

1. **画像アップロード** → 複数画像の同時処理可能
2. **OCR処理** → site7のテキストデータ抽出
3. **グラフ領域検出** → オレンジバーとゼロライン検出
4. **画像切り抜き** → ±30,000玉の範囲を精密に切り抜き
5. **グラフ解析** → ラインを検出してデータポイント抽出
6. **統計計算** → MAX、MIN、現在値、初当たり値
7. **結果表示** → 視覚的にわかりやすく表示

## 🔑 重要な技術詳細

### ゼロライン検出アルゴリズム
```python
# 1. オレンジバー検出（HSV色空間）
orange_mask = cv2.inRange(hsv, np.array([10, 100, 100]), np.array([30, 255, 255]))

# 2. オレンジバーの下端を特定
for y in range(height//2):
    if np.sum(orange_mask[y, :]) > width * 0.3 * 255:
        orange_bottom = y

# 3. ゼロライン検出（暗い水平線）
for y in range(search_start, search_end):
    darkness = 1.0 - (np.mean(row) / 255.0)
    uniformity = 1.0 - (np.std(row) / 128.0)
    score = darkness * 0.5 + uniformity * 0.5
```

### 切り抜きパラメータ（固定値）
- **上部**: ゼロラインから246ピクセル上
- **下部**: ゼロラインから247ピクセル下
- **左右**: 125ピクセルずつ除外
- **スケール**: 30,000玉 ÷ 246px ≈ 122玉/px

### グラフデータ抽出
```python
# 色の範囲（HSV）
color_ranges = {
    'pink': [(320, 30, 30), (350, 255, 255)],
    'magenta': [(280, 30, 30), (320, 255, 255)],
    'red': [(0, 30, 30), (10, 255, 255)],
    # ... 他の色
}

# エッジ検出とライン追跡
edges = cv2.Canny(blurred, 30, 100)
# 各x座標で最も明るい点を検出
```

### OCR処理
```python
# Tesseract OCRで日本語テキスト抽出
text = pytesseract.image_to_string(adjusted, lang='jpn')

# パターンマッチングで各データを抽出
patterns = {
    'total_start': r'(\d{3,4})\s*スタート',
    'jackpot_count': r'(\d+)\s*回\s*大当り',
    'jackpot_probability': r'1/(\d{2,4})',
    # ... 他のパターン
}
```

## 🚀 パフォーマンス最適化

### 実装済みの最適化
1. **画像の事前処理**: コントラスト調整でOCR精度向上
2. **並列処理**: 複数画像の同時処理
3. **キャッシュ**: Streamlitの`@st.cache_data`活用
4. **メモリ効率**: 大きな画像の段階的処理

### 今後の最適化候補
1. **GPU活用**: OpenCVのGPU版使用
2. **非同期処理**: asyncioによる並列化
3. **画像圧縮**: アップロード前の自動圧縮

## 🧪 実験的機能（現在無効化）

### 1回転あたりの消費球数推定
```python
# グラフの下降部分から傾きを計算
if change < -10 and x_diff_spins > 0.5:
    slope = abs(change) / x_diff_spins
    if 5 <= slope <= 35:  # 妥当な範囲
        slopes.append(slope)
```

この機能は`if False:`で無効化されていますが、将来的に有効化可能です。

## 🐛 既知の問題と対処法

### 1. OCRの認識精度
- **問題**: 累計スタートなどの数値が認識されない場合がある
- **原因**: フォントや画像品質
- **対処**: コントラスト調整、複数のOCR設定試行

### 2. グラフ色の誤検出
- **問題**: 似た色のグラフを誤認識
- **原因**: HSV色空間の範囲重複
- **対処**: より厳密な色範囲設定

### 3. ゼロライン検出失敗
- **問題**: まれにゼロラインを誤検出
- **原因**: 画像の品質や形式の違い
- **対処**: 複数の検出アルゴリズムの組み合わせ

## 📝 コーディング規約

### 命名規則
- **関数名**: snake_case（例: `extract_graph_data`）
- **定数**: UPPER_SNAKE_CASE（例: `ZERO_LINE_OFFSET_TOP`）
- **クラス名**: PascalCase（例: `WebCompatibleAnalyzer`）

### コメント
- 重要なロジックには日本語コメントを追加
- 数値の単位を明記（例: `# 246px = 30,000玉`）

### エラーハンドリング
```python
try:
    # 処理
except Exception as e:
    st.warning(f"エラーが発生しました: {str(e)}")
    # デフォルト値で継続
```

## 🔄 開発ワークフロー

### 新機能追加時
1. 機能の影響範囲を確認
2. `web_analyzer.py`に解析ロジックを実装
3. `streamlit_app_full.py`にUI要素を追加
4. エラーハンドリングを実装
5. テスト画像で動作確認

### バグ修正時
1. エラーログから原因特定
2. 最小限の変更で修正
3. 関連機能への影響確認
4. 複数の画像でテスト

## 📦 デプロイメント

### Streamlit Cloud
- **メインファイル**: `web_app/streamlit_app_full.py`
- **Python**: 3.8以上
- **追加パッケージ**: `packages.txt`に`tesseract-ocr tesseract-ocr-jpn`

### ローカル開発
```bash
# 開発サーバー起動
streamlit run web_app/streamlit_app_full.py --server.runOnSave true

# デバッグモード
streamlit run web_app/streamlit_app_full.py --logger.level debug
```

## 🎯 今後の開発方針

### 短期目標
1. OCR精度の向上
2. 処理速度の最適化
3. エラーメッセージの改善

### 中期目標
1. 実験的機能の本格実装
2. バッチ処理機能
3. データエクスポート機能

### 長期目標
1. 機械学習による精度向上
2. 他サイトフォーマット対応
3. API化

## 📞 サポート情報

- **開発元**: ファイブナインデザイン
- **クライアント**: PPタウン様
- **最終更新**: 2025年1月1日

---

このドキュメントは、AIアシスタントが効率的に開発を支援できるよう、プロジェクトの全体像と重要な技術詳細をまとめたものです。